import supabase from '../../frontend/src/services/supabase-client'

const verbList = [
  "generate", "create", "give me"
];

const questData =  //load from DB. Example below
{
  faction: "Bandits",
  location: "Whispering Woods",
  object: "a stolen caravan",
  quest_hook: "Bandits have captured a merchant caravan in the Whispering Woods, and the desperate survivors plead for aid."
};

async function generateTrainingPair(quest) {
  // 1. Get templates whose required fields are all included in the quest data
  const { data: templates } = await supabase
    .from('input_templates')
    .select('*');

  const eligibleTemplates = templates.filter(t =>
    t.required_fields.every(field => quest[field] !== undefined)
  );

  if (eligibleTemplates.length === 0) {
    console.log("No valid template found.");
    return null;
  }

  // 2. Pick random template
  const template = eligibleTemplates[Math.floor(Math.random() * eligibleTemplates.length)];

  // 3. Build dynamic input
  let input = template.template;

  // Insert variable values
  template.required_fields.forEach(field => {
    input = input.replace(`{${field}}`, quest[field]);
  });

  // 4. Optional: randomize verbs
  if (template.randomness) {
    const randomVerb = verbList[Math.floor(Math.random() * verbList.length)];
    input = input.replace("{verb}", randomVerb);
  }

  // 5. Store pair in `training_pairs` table
  const { data, error } = await supabase
    .from('training_pairs')
    .insert({
      input_prompt: input,
      output_text: quest.quest_hook,
      quest_id: quest.id || null
    })
    .select();

  if (error) console.error(error);
  else console.log("Training pair created:", data);

  return data;
}

generateTrainingPair(questData);